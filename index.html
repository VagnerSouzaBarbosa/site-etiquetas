<!DOCTYPE html>
<html lang="pt-BR" class="dark-mode">
<head>
  <meta charset="UTF-8">
  <title>Registro de Falhas de Etiquetas</title>
  <link rel="icon" type="image/x-icon" href="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRAdRZj6UwfwUFfvlmCfFUDzQMDJz7YZioF_de0F8SLA5yHB8dxPEFCCUgEDGW4ERl8-fI&usqp=CAU">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Poppins:wght@600;700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Poppins:wght@600;700&display=swap"></noscript>
  
  <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"></noscript>

  <style>
    :root {
      /* Paleta Elegante (Azul Escuro e Dourado) */
      --bg-dark: #0a192f;
      --card-bg-dark: #112240;
      --text-dark: #ccd6f6;
      --text-muted-dark: #8892b0;
      --border-dark: #233554;
      --accent-color: #FFD700; /* Dourado */
      --accent-dark: #D4AF37; /* Dourado mais escuro */
      
      /* Paleta Clara (Mantida para o modo claro, se necessário) */
      --bg-light: #f4f7fa; 
      --card-bg-light: #ffffff; 
      --text-light: #2c3e50; 
      --text-muted-light: #7f8c8d; 
      --border-light: #e0e6ed;
      
      --success-color: #2ecc71; 
      --danger-color: #e74c3c;
      --coleta-color: #e67e22; /* Laranja para Coleta */
      --radius: 12px; 
      --shadow: 0 10px 30px rgba(0, 0, 0, 0.1); 
      --transition: all 0.3s ease-in-out;
    }
    html.light-mode { --bg: var(--bg-light); --card-bg: var(--card-bg-light); --text-primary: var(--text-light); --text-muted: var(--text-muted-light); --border-color: var(--border-light); }
    html.dark-mode { --bg: var(--bg-dark); --card-bg: var(--card-bg-dark); --text-primary: var(--text-dark); --text-muted: var(--text-muted-dark); --border-color: var(--border-dark); }
    * { box-sizing: border-box; margin:0; padding:0; }
    body {
      color: var(--text-primary); font-family: 'Inter', sans-serif;
      padding: 2rem 1rem; min-height: 100vh; transition: var(--transition);
      background-color: var(--bg);
      background-size: cover;
      background-position: center center;
      background-attachment: fixed;
    }
    html.light-mode body {
        background-image: linear-gradient(rgba(244, 247, 250, 0.95), rgba(244, 247, 250, 0.95)), url('planodefundo.jpg');
    }
    html.dark-mode body {
        background-image: linear-gradient(rgba(10, 25, 47, 0.95), rgba(10, 25, 47, 0.95)), url('planodefundoescuro.jpg');
    }
    .page { display: none; }
    .page.active { display: block; animation: fadeInPage 0.5s ease-out; }
    @keyframes fadeInPage { from { opacity: 0; } to { opacity: 1; } }

    /* Estilos da Tela de Login */
    #login-page {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        height: calc(100vh - 4rem);
    }
    #login-card {
        width: 100%;
        max-width: 450px;
    }
    #login-card .header-title {
        flex-direction: column;
        gap: 1.5rem;
        padding-bottom: 2rem;
    }
    #login-card h1 { font-size: 1.5rem; color: #0a192f; }
    #login-card .body { padding-top: 1rem;}

    .app-layout {
        display: none; /* Inicia oculto */
        justify-content: center;
        width: 100%;
        max-width: 1600px;
        margin: 0 auto;
    }
    .app-layout.active {
        display: flex; /* Mostra quando ativo */
        align-items: flex-start;
        gap: 2rem;
    }
    .main-content {
        width: 100%;
        max-width: 850px;
        flex-shrink: 0;
    }
    .card { 
        background-color: var(--card-bg); 
        border-radius: var(--radius); 
        box-shadow: var(--shadow); 
        transition: var(--transition); 
        overflow: hidden;
        border: 1px solid var(--accent-color);
    }
    .header {
      background: linear-gradient(135deg, var(--accent-dark) 0%, var(--accent-color) 100%); 
      color: #0a192f; 
      display: flex; align-items: center; justify-content: space-between; padding: 1.5rem;
      border-bottom: 2px solid var(--accent-color);
    }
    .header-title { display: flex; align-items: center; gap: 1rem; }
    .header img { 
      width: 60px; 
      height: 60px;
      border-radius: 50%;
      background: white; 
      padding: 5px; 
      object-fit: contain;
    }
    .header h1 {
        font-family: 'Poppins', sans-serif;
        font-size: 1.7rem;
    }
    .header-actions { display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: flex-end; }
    .header-actions button {
      background: rgba(10, 25, 47, 0.2); border: 1px solid rgba(255,215,0,0.3); color: #0a192f; width: 40px; height: 40px; border-radius: 50%;
      font-size: 1.2rem; cursor: pointer; transition: var(--transition); display: flex; align-items: center; justify-content: center;
    }
    .header-actions button:hover { background: rgba(10, 25, 47, 0.4); transform: translateY(-2px); }
    .body { padding: 2rem; }
    section { margin-bottom: 2.5rem; }
    h2 {
      font-family: 'Poppins', sans-serif; font-size: 1.5rem; padding-bottom: 0.75rem; border-bottom: 2px solid var(--accent-color);
      margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem; color: var(--accent-color);
    }
    .form-group { margin-bottom: 1.5rem; }
    .form-group label { display: block; font-weight: 700; font-size: 0.9rem; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; }
    .form-group i { color: var(--text-muted); }
    .form-group input, .form-group select, .form-group textarea {
      width:100%; padding: 0.9rem; margin-top: 0.2rem; border: 1px solid var(--border-color); border-radius: 8px;
      font-size: 1rem; background-color: var(--bg); color: var(--text-primary); transition: var(--transition);
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { 
      border-color: var(--accent-color); 
      box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.2); 
      outline: none; 
    }
    .actions { margin-top: 2rem; text-align: center; }
    .btn {
      background:var(--accent-color); color: #0a192f; border:none; padding: 0.9rem 2rem; font-size: 1.1rem; font-weight: 700;
      border-radius: 8px; cursor:pointer; transition: var(--transition); display: inline-flex; align-items: center; gap: 0.5rem;
    }
    .btn:hover { background:var(--accent-dark); transform: translateY(-2px); }
    .btn:disabled { background: #999; cursor: not-allowed; transform: none; }
    
    @media (max-width: 600px) {
        body { padding: 1rem; }
        .header { padding: 1rem; flex-direction: column; gap: 1rem; }
        .header-title { flex-direction: column; text-align: center; }
        .header h1 { font-size: 1.3rem; }
        h2 { font-size: 1.2rem; }
        .body { padding: 1.5rem; }
        .btn { padding: 0.8rem 1.2rem; font-size: 1rem; }
    }
  </style>
</head>
<body>
  
  <div id="login-page" class="page active">
    <div id="login-card" class="card">
        <header class="header">
          <div class="header-title">
            <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRAdRZj6UwfwUFfvlmCfFUDzQMDJz7YZioF_de0F8SLA5yHB8dxPEFCCUgEDGW4ERl8-fI&usqp=CAU" alt="Logo">
            <h1>Bem-vindo!</h1>
          </div>
        </header>
        <main class="body">
            <p style="text-align: center; color: var(--text-muted); margin-bottom: 2rem;">Por favor, identifique-se para continuar.</p>
            <form id="login-form">
                <div class="form-group">
                    <label for="login-nome"><i class="fas fa-user"></i> Seu Nome</label>
                    <input type="text" id="login-nome" required placeholder="Nome completo">
                </div>
                <div class="form-group">
                    <label for="login-unidade"><i class="fas fa-building"></i> Sua Unidade</label>
                    <select id="login-unidade" required>
                        <option value="" disabled selected>Selecione sua unidade</option>
                    </select>
                </div>
                <div class="actions">
                    <button type="submit" class="btn">Entrar</button>
                </div>
            </form>
        </main>
    </div>
  </div>

  <div class="app-layout" id="app-layout">
    <aside class="sidebar sidebar-left">
        </aside>

    <div class="main-content">
        <div id="main-page" class="page active">
          <div class="card">
            <header class="header">
              <div class="header-title">
                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRAdRZj6UwfwUFfvlmCfFUDzQMDJz7YZioF_de0F8SLA5yHB8dxPEFCCUgEDGW4ERl8-fI&usqp=CAU" alt="Logo">
                <h1 id="main-title">Registro de Falhas</h1>
              </div>
              <div class="header-actions">
                <button id="aiReportBtn" title="Relatório IA"><i class="fas fa-robot"></i></button>
                <button id="themeToggleBtn" title="Alternar Modo"><i class="fas fa-sun"></i></button>
                <button id="infoBtn" title="Sobre esta página"><i class="fas fa-info-circle"></i></button>
                <button id="viewRecordsBtn" title="Ver Registros"><i class="fas fa-list-alt"></i></button>
              </div>
            </header>
            <main class="body">
              <section id="form-section">
                <h2><i class="fas fa-pencil-alt"></i> Novo Registro de Falha</h2>
                <form id="feedForm" novalidate>
                  <div class="form-group"><label for="data"><i class="fas fa-calendar-alt"></i> Data da Ocorrência</label><input type="date" id="data" name="data" required></div>
                  <div class="form-group"><label for="unidade"><i class="fas fa-building"></i> Unidade</label><select id="unidade" name="unidade" required><option value="" disabled selected>Selecione a unidade</option></select></div>
                  <div class="form-group"><label for="responsavel"><i class="fas fa-user"></i> Responsável</label><input type="text" id="responsavel" name="responsavel" required placeholder="Seu nome completo" disabled></div>
                  <div class="form-group"><label for="quantidade"><i class="fas fa-sort-numeric-up"></i> Quantidade</label><input type="number" id="quantidade" name="quantidade" min="1" required></div>
                  <div class="form-group"><label for="comentario"><i class="fas fa-comment-dots"></i> Descrição da Falha</label><textarea id="comentario" name="comentario" rows="4" required placeholder="Ex.: A etiqueta está descolando..."></textarea></div>
                  <div class="form-group">
                    <label for="foto"><i class="fas fa-camera"></i> Foto (Opcional)</label>
                    <input type="file" id="foto" name="foto" accept="image/*">
                    <button type="button" id="analyzeImageBtn" class="btn secondary" disabled style="margin-top: 0.5rem;">✨ Analisar Imagem</button>
                  </div>
                  <div class="actions"><button type="submit" class="btn" id="registerBtn"><i class="fas fa-paper-plane"></i> Registrar Falha</button></div>
                </form>
              </section>
              <section id="data-section">
                <h2><i class="fas fa-chart-pie"></i> Resumo Geral</h2><div id="numerical-summary" class="numerical-summary"></div>
              </section>
              
              <section class="notice-board-inline">
                  </section>

              <section id="checklist-section">
                <h2><i class="fas fa-tasks"></i> Status de Registro por Unidade</h2><div class="checklist"><div id="checklist-container"></div></div>
              </section>
              <div id="counters">
                <p id="checklist-count">Unidades com registro: 0 / 0</p><p id="visitor-count">Total de Visitas: 0</p>
              </div>
            </main>
          </div>
        </div>

        <div id="report-page" class="page">
          <div class="card">
            <div id="report-content-to-print">
                <header class="header">
                  <div class="header-title"><h1><i class="fas fa-robot"></i> Relatório de Análise</h1></div>
                  <div class="header-actions"><button id="backToMainBtn" title="Voltar"><i class="fas fa-arrow-left"></i></button></div>
                </header>
                <main class="body">
                  <section>
                    <h2><i class="fas fa-chart-pie"></i> Análise Gráfica</h2>
                    <div class="report-charts">
                      <div class="chart-card"><h3>Distribuição de Falhas</h3><canvas id="failuresByUnitChart"></canvas></div>
                      <div class="chart-card"><h3>Unidades com Registro</h3><canvas id="reportingUnitsChart"></canvas></div>
                      <div class="chart-card"><h3>Top 5 Unidades</h3><canvas id="topUnitsChart"></canvas></div>
                    </div>
                  </section>
                  <section id="ai-report-section">
                    <h2><i class="fas fa-magic"></i> Relatório para Fornecedor</h2>
                    <div id="ai-report-output" style="margin-top:0;">Clique em "Gerar Análise" para criar o relatório...</div>
                  </section>
                   <section id="ai-management-section">
                    <h2><i class="fas fa-lightbulb"></i> ✨ Insights de Gestão</h2>
                    <div id="ai-management-output" style="margin-top:0;">Clique em "Gerar Insights" para criar um resumo executivo...</div>
                  </section>
                </main>
            </div>
            <div class="body" style="padding-top: 0;">
                <div class="form-navigation" style="justify-content: space-between;">
                    <button class="btn" id="generateAiTextBtn"><i class="fas fa-cogs"></i> Gerar para Fornecedor</button>
                    <button class="btn" id="generateManagementReportBtn" style="background-color: var(--success-color);"><i class="fas fa-lightbulb"></i> Gerar Insights</button>
                    <div>
                      <button class="btn secondary" id="copyReportBtn" disabled><i class="fas fa-copy"></i> Copiar</button>
                      <button class="btn" id="generatePdfBtn" disabled style="margin-left: 1rem; background-color: var(--danger-color);"><i class="fas fa-file-pdf"></i> Gerar PDF</button>
                    </div>
                </div>
            </div>
          </div>
        </div>
    </div>
    
    <aside class="sidebar sidebar-right">
        </aside>
  </div>

  <div id="mainModal" class="modal">
      </div>
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" defer></script>
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyANadM-WbuGFKp5dz_09rjtsLUX-DTu908",
      authDomain: "etiquetas-falhas.firebaseapp.com",
      projectId: "etiquetas-falhas",
      storageBucket: "etiquetas-falhas.appspot.com",
      messagingSenderId: "895360142111",
      appId: "1:895360142111:web:864dc9b0d4c62016dc3e2a",
      measurementId: "G-31F5QV4YZ8"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    document.addEventListener('DOMContentLoaded', () => {
      // --- CONSTANTES ---
      const USER_INFO_KEY = 'userInfo_v2';
      const unidades = ["ALTIPLANO", "BAIRRO DOS ESTADOS", "BANCARIOS", "BAYEUX", "BESSA", "BESSA II", "CABEDELO", "CRISTO REDENTOR", "CRUZ DAS ARMAS", "EPITÁCIO", "GEISEL", "GUARABIRA", "INTERMARES", "MAMANGUAPE", "MANAÍRA", "MANGABEIRA", "NOVA DIAGNÓSTICO", "PATOS", "SANTA RITA", "SAPÉ", "SAPÉ II", "TAMBÁU", "TORRE", "VALENTINA", "COLETA DOMICILIAR"];
      
      // --- SELETORES DE DOM ---
      const dom = {
          loginPage: document.getElementById('login-page'),
          appLayout: document.getElementById('app-layout'),
          loginForm: document.getElementById('login-form'),
          loginNome: document.getElementById('login-nome'),
          loginUnidade: document.getElementById('login-unidade'),
          mainUnidadeSelect: document.getElementById('unidade'),
          mainResponsavelInput: document.getElementById('responsavel'),
          mainTitle: document.getElementById('main-title'),
          fotoInput: document.getElementById('foto'),
          analyzeImageBtn: document.getElementById('analyzeImageBtn'),
          comentarioTextarea: document.getElementById('comentario'),
          generateManagementReportBtn: document.getElementById('generateManagementReportBtn'),
          aiManagementOutput: document.getElementById('ai-management-output'),
          // ... (restantes seletores de DOM da app principal)
      };

      // --- LÓGICA DE INICIALIZAÇÃO ---
      const app = {
        init() {
          this.populateUnidades();
          this.checkSession();
          this.bindLoginEvents();
          this.bindMainAppEvents();
        },
        populateUnidades() {
            unidades.sort().forEach(unit => {
                dom.loginUnidade.add(new Option(unit, unit));
                dom.mainUnidadeSelect.add(new Option(unit, unit));
            });
        },
        checkSession() {
            const userInfo = JSON.parse(sessionStorage.getItem(USER_INFO_KEY));
            if (userInfo && userInfo.name && userInfo.unit) {
                this.showApp(userInfo);
            } else {
                dom.loginPage.classList.add('active');
            }
        },
        bindLoginEvents() {
            dom.loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = dom.loginNome.value.trim();
                const unit = dom.loginUnidade.value;

                if (name && unit) {
                    const userInfo = { name, unit };
                    sessionStorage.setItem(USER_INFO_KEY, JSON.stringify(userInfo));
                    this.showApp(userInfo);
                } else {
                    alert('Por favor, preencha todos os campos.');
                }
            });
        },
        showApp(userInfo) {
            dom.loginPage.style.display = 'none';
            dom.appLayout.classList.add('active');
            this.prefillForm(userInfo);
        },
        prefillForm(userInfo) {
            dom.mainResponsavelInput.value = userInfo.name;
            dom.mainUnidadeSelect.value = userInfo.unit;
            dom.mainTitle.textContent = `Unidade: ${userInfo.unit}`;
        },
        bindMainAppEvents() {
            // ... (todos os outros event listeners da app principal)
            dom.fotoInput.addEventListener('change', () => {
                dom.analyzeImageBtn.disabled = !dom.fotoInput.files.length;
            });
            dom.analyzeImageBtn.addEventListener('click', this.handleImageAnalysis);
            dom.generateManagementReportBtn.addEventListener('click', this.handleGenerateManagementReport);
        },
        handleImageAnalysis: async () => {
            const file = dom.fotoInput.files[0];
            if (!file) return;

            dom.analyzeImageBtn.disabled = true;
            dom.analyzeImageBtn.innerHTML = '<div class="loader"></div> Analisando...';

            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = async () => {
                const base64ImageData = reader.result.split(',')[1];
                const prompt = "Analise esta imagem de uma etiqueta de laboratório com defeito. Descreva o problema de forma concisa e objetiva. Por exemplo: 'Etiqueta com falha de impressão na parte superior' ou 'Etiqueta descolando na lateral direita'.";

                try {
                    const payload = {
                        contents: [{
                            parts: [
                                { text: prompt },
                                { inline_data: { mime_type: file.type, data: base64ImageData } }
                            ]
                        }]
                    };
                    const apiKey = "";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`API Error: ${response.status}`);
                    const result = await response.json();
                    const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (text) {
                        dom.comentarioTextarea.value = text;
                    } else {
                        throw new Error("Resposta da IA inválida.");
                    }
                } catch (error) {
                    alert(`Erro ao analisar a imagem: ${error.message}`);
                } finally {
                    dom.analyzeImageBtn.disabled = false;
                    dom.analyzeImageBtn.innerHTML = '✨ Analisar Imagem';
                }
            };
        },
        handleGenerateManagementReport: async () => {
            // Lógica similar a handleGenerateAiReport, mas com prompt e output diferentes
            const btn = dom.generateManagementReportBtn;
            btn.disabled = true;
            btn.innerHTML = '<div class="loader"></div> Gerando...';
            dom.aiManagementOutput.textContent = "Analisando dados para o resumo executivo...";
            
            const dataSummary = allFeedbacks.map(f => `Unidade: ${f.unidade}, Qtde: ${f.quantidade}, Desc: ${f.comentario}`).join('; ');
            const prompt = `Aja como um gestor de qualidade. Com base nos seguintes dados, crie um resumo executivo interno (insights de gestão). O resumo deve: 1. Apresentar o número total de falhas e o impacto geral. 2. Identificar as 3 unidades com mais registos e sugerir uma verificação de processos locais. 3. Apontar padrões ou tendências nos tipos de falhas descritas (ex: problemas recorrentes de adesivo, falhas de impressão). 4. Sugerir um ponto de foco para a melhoria contínua interna. Assine como "Análise de Gestão da Qualidade". Dados: ${dataSummary}`;

            try {
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                const result = await response.json();
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!text) throw new Error("Resposta da IA inválida.");
                dom.aiManagementOutput.textContent = text;
            } catch (error) {
                dom.aiManagementOutput.textContent = `Erro ao gerar insights: ${error.message}`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-lightbulb"></i> Gerar Insights Novamente';
            }
        }
        // ... (restante da lógica da aplicação principal)
      };

      app.init();
    });
  </script>
</body>
</html>
