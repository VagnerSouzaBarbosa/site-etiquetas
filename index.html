<!DOCTYPE html>
<html lang="pt-BR" class="light-mode">
<head>
  <meta charset="UTF-8">
  <title>Registro de Falhas de Etiquetas</title>
  <link rel="icon" type="image/x-icon" href="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRAdRZj6UwfwUFfvlmCfFUDzQMDJz7YZioF_de0F8SLA5yHB8dxPEFCCUgEDGW4ERl8-fI&usqp=CAU">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    :root {
      --bg-light: #f4f7fa; --card-bg-light: #ffffff; --text-light: #2c3e50; --text-muted-light: #7f8c8d; --border-light: #e0e6ed;
      --accent-color: #3498db; --accent-dark: #2980b9; --success-color: #2ecc71; --danger-color: #e74c3c;
      --bg-dark: #2c3e50; --card-bg-dark: #34495e; --text-dark: #ecf0f1; --text-muted-dark: #bdc3c7; --border-dark: #4a627a;
      --radius: 12px; --shadow: 0 10px 30px rgba(0, 0, 0, 0.07); --transition: all 0.3s ease-in-out;
    }
    html.light-mode { --bg: var(--bg-light); --card-bg: var(--card-bg-light); --text-primary: var(--text-light); --text-muted: var(--text-muted-light); --border-color: var(--border-light); }
    html.dark-mode { --bg: var(--bg-dark); --card-bg: var(--card-bg-dark); --text-primary: var(--text-dark); --text-muted: var(--text-muted-dark); --border-color: var(--border-dark); }
    * { box-sizing: border-box; margin:0; padding:0; }
    body {
      background-color: var(--bg); color: var(--text-primary); font-family: 'Inter', sans-serif;
      display: flex; justify-content: center; align-items: flex-start; padding: 2rem 1rem; min-height: 100vh; transition: var(--transition);
    }
    .container { width: 100%; max-width: 850px; }
    .card { background-color: var(--card-bg); border-radius: var(--radius); box-shadow: var(--shadow); transition: var(--transition); overflow: hidden; }
    .header {
      background: var(--accent-color); color: white; display: flex; align-items: center; justify-content: space-between; padding: 1.5rem;
    }
    .header-title { display: flex; align-items: center; gap: 1rem; }
    .header img { 
      width: 60px; 
      height: 60px;
      border-radius: 50%;
      background: white; 
      padding: 5px; 
      object-fit: contain;
    }
    .header-actions { display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: flex-end; }
    .header-actions button {
      background: rgba(255,255,255,0.2); border: none; color: white; width: 40px; height: 40px; border-radius: 50%;
      font-size: 1.2rem; cursor: pointer; transition: var(--transition); display: flex; align-items: center; justify-content: center;
    }
    .header-actions button:hover { background: rgba(255,255,255,0.4); transform: translateY(-2px); }
    .body { padding: 2rem; }
    section { margin-bottom: 2.5rem; }
    h2 {
      font-family: 'Poppins', sans-serif; font-size: 1.5rem; padding-bottom: 0.75rem; border-bottom: 2px solid var(--accent-color);
      margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem; color: var(--accent-color);
    }
    .form-group { margin-bottom: 1.5rem; }
    .form-group label { display: block; font-weight: 700; font-size: 0.9rem; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; }
    .form-group i { color: var(--text-muted); }
    .form-group input, .form-group select, .form-group textarea {
      width:100%; padding: 0.9rem; margin-top: 0.2rem; border: 1px solid var(--border-color); border-radius: 8px;
      font-size: 1rem; background-color: var(--bg); color: var(--text-primary); transition: var(--transition);
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color: var(--accent-color); box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2); outline: none; }
    .actions { margin-top: 2rem; text-align: center; }
    .btn {
      background:var(--accent-color); color: white; border:none; padding: 0.9rem 2rem; font-size: 1.1rem; font-weight: 700;
      border-radius: 8px; cursor:pointer; transition: var(--transition); display: inline-flex; align-items: center; gap: 0.5rem;
    }
    .btn:hover { background:var(--accent-dark); transform: translateY(-2px); }
    .btn:disabled { background: #999; cursor: not-allowed; transform: none; }
    
    .page { display: none; }
    .page.active { display: block; animation: fadeInPage 0.5s ease-out; }
    @keyframes fadeInPage { from { opacity: 0; } to { opacity: 1; } }

    .report-charts { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem; margin-bottom: 2.5rem; }
    .chart-card { 
      background-color: var(--card-bg); 
      padding: 1.5rem; 
      border-radius: var(--radius); 
      border: 1px solid var(--border-color);
      position: relative; /* CORREÇÃO: Adicionado para dar contexto ao canvas */
      height: 350px; /* CORREÇÃO: Altura definida para o container do gráfico */
    }
    .chart-card h3 { text-align: center; margin-bottom: 1.5rem; font-family: 'Poppins', sans-serif; font-size: 1.1rem; }
    #ai-report-section { background-color: var(--card-bg); border: 1px solid var(--border-color); padding: 1.5rem; border-radius: var(--radius); }
    #ai-report-output { margin-top: 1.5rem; padding: 1.5rem; border-radius: 8px; background-color: var(--bg); min-height: 150px; white-space: pre-wrap; line-height: 1.6; }
    .loader { width: 20px; height: 20px; border: 3px solid var(--text-muted); border-top-color: var(--accent-color); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .numerical-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; }
    .stat-card { background-color: var(--card-bg); padding: 1.5rem; border-radius: var(--radius); border: 1px solid var(--border-color); text-align: center; transition: var(--transition); }
    .stat-card:hover { transform: translateY(-5px); box-shadow: var(--shadow); }
    .stat-card i { font-size: 2.5rem; color: var(--accent-color); margin-bottom: 1rem; }
    .stat-card h4 { font-family: 'Poppins', sans-serif; font-size: 1rem; color: var(--text-muted); margin-bottom: 0.5rem; }
    .stat-card p { font-size: 2.5rem; font-weight: 700; }
    #unit-breakdown-list { list-style-type: none; padding: 0; max-height: 180px; overflow-y: auto; text-align: left; margin-top: 1rem; }
    .checklist { background-color: var(--card-bg); border: 1px solid var(--border-color); padding:1.5rem; border-radius:var(--radius); }
    #checklist-container { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:.75rem 1.5rem; max-height:250px; overflow-y:auto; padding-top: 1rem; }
    #checklist-container label { display:flex; align-items:center; gap:.5rem; font-size:.9rem; opacity: 0.8; }
    #checklist-container input[type="checkbox"] { pointer-events: none; }
    #counters { margin-top:2rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color); text-align:center; font-size:1rem; font-weight:700; display: flex; justify-content: space-around; gap: 1rem; color: var(--text-muted); }
    
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); justify-content: center; align-items: center; animation: fadeInModal 0.3s; }
    .modal-content { background-color: var(--card-bg); margin: auto; padding: 2rem; width: 90%; max-width: 600px; border-radius: var(--radius); box-shadow: 0 5px 15px rgba(0,0,0,0.3); animation: slideInModal 0.4s ease-out; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 1rem; margin-bottom: 1rem; border-bottom: 1px solid var(--border-color); }
    .modal-header h3 { font-family: 'Poppins', sans-serif; font-size: 1.5rem; color: var(--accent-color); }
    .modal-header .close-btn { font-size: 1.8rem; cursor: pointer; color: var(--text-muted); background: none; border: none; }
  </style>
</head>
<body>
  <div class="container">
    <!-- PÁGINA PRINCIPAL -->
    <div id="main-page" class="page active">
      <div class="card">
        <header class="header">
          <div class="header-title">
            <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRAdRZj6UwfwUFfvlmCfFUDzQMDJz7YZioF_de0F8SLA5yHB8dxPEFCCUgEDGW4ERl8-fI&usqp=CAU" alt="Logo">
            <h1>Registro de Falhas</h1>
          </div>
          <div class="header-actions">
            <button id="aiReportBtn" title="Relatório IA"><i class="fas fa-robot"></i></button>
            <button id="themeToggleBtn" title="Alternar Modo"><i class="fas fa-moon"></i></button>
            <button id="infoBtn" title="Sobre esta página"><i class="fas fa-info-circle"></i></button>
            <button id="viewRecordsBtn" title="Ver Registros"><i class="fas fa-list-alt"></i></button>
          </div>
        </header>
        <main class="body">
          <section id="form-section">
            <h2><i class="fas fa-pencil-alt"></i> Novo Registro de Falha</h2>
            <form id="feedForm" novalidate>
              <div class="form-group"><label for="data"><i class="fas fa-calendar-alt"></i> Data da Ocorrência</label><input type="date" id="data" name="data" required></div>
              <div class="form-group"><label for="unidade"><i class="fas fa-building"></i> Unidade</label><select id="unidade" name="unidade" required><option value="" disabled selected>Selecione a unidade</option></select></div>
              <div class="form-group"><label for="responsavel"><i class="fas fa-user"></i> Responsável pelo Registro</label><input type="text" id="responsavel" name="responsavel" required placeholder="Seu nome completo"></div>
              <div class="form-group"><label for="quantidade"><i class="fas fa-sort-numeric-up"></i> Quantidade de Falhas</label><input type="number" id="quantidade" name="quantidade" min="1" required></div>
              <div class="form-group"><label for="comentario"><i class="fas fa-comment-dots"></i> O que está acontecendo com as etiquetas?</label><textarea id="comentario" name="comentario" rows="4" required placeholder="Ex.: A etiqueta está descolando do tubo na lateral esquerda, a impressão está falhando..."></textarea></div>
              <div class="form-group"><label for="foto"><i class="fas fa-camera"></i> Foto da Falha (Opcional)</label><input type="file" id="foto" name="foto" accept="image/*"></div>
              
              <div class="actions">
                <button type="submit" class="btn" id="registerBtn"><i class="fas fa-paper-plane"></i> Registrar Falha</button>
              </div>
            </form>
          </section>
          <section id="data-section">
            <h2><i class="fas fa-chart-pie"></i> Resumo Geral</h2><div id="numerical-summary" class="numerical-summary"></div>
          </section>
          <section id="checklist-section">
            <h2><i class="fas fa-tasks"></i> Status de Registro por Unidade</h2><div class="checklist"><div id="checklist-container"></div></div>
          </section>
          <div id="counters">
            <p id="checklist-count">Unidades com registro: 0 / 0</p><p id="visitor-count">Total de Visitas: 0</p>
          </div>
        </main>
      </div>
    </div>

    <!-- PÁGINA DE RELATÓRIO -->
    <div id="report-page" class="page">
      <div class="card">
        <div id="report-content-to-print">
            <header class="header">
              <div class="header-title"><h1><i class="fas fa-robot"></i> Relatório de Análise</h1></div>
              <div class="header-actions"><button id="backToMainBtn" title="Voltar"><i class="fas fa-arrow-left"></i></button></div>
            </header>
            <main class="body">
              <section>
                <h2><i class="fas fa-chart-pie"></i> Análise Gráfica</h2>
                <div class="report-charts">
                  <div class="chart-card"><h3>Distribuição de Falhas por Unidade</h3><canvas id="failuresByUnitChart"></canvas></div>
                  <div class="chart-card"><h3>Unidades com/sem Registro</h3><canvas id="reportingUnitsChart"></canvas></div>
                  <div class="chart-card"><h3>Top 5 Unidades com Mais Falhas</h3><canvas id="topUnitsChart"></canvas></div>
                </div>
              </section>
              <section id="ai-report-section">
                <h2><i class="fas fa-magic"></i> Relatório para Fornecedor (Gerado por IA)</h2>
                <div id="ai-report-output" style="margin-top:0;">Clique no botão "Gerar Análise" abaixo para criar o relatório...</div>
              </section>
            </main>
        </div>
        <div class="body" style="padding-top: 0;">
            <div class="form-navigation" style="justify-content: space-between;">
                <button class="btn" id="generateAiTextBtn"><i class="fas fa-cogs"></i> Gerar Análise</button>
                <div>
                  <button class="btn secondary" id="copyReportBtn" disabled><i class="fas fa-copy"></i> Copiar</button>
                  <button class="btn" id="generatePdfBtn" disabled style="margin-left: 1rem; background-color: var(--danger-color);"><i class="fas fa-file-pdf"></i> Gerar PDF</button>
                </div>
            </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Genérico -->
  <div id="mainModal" class="modal">
    <div class="modal-content">
      <div class="modal-header"><h3 id="modalTitle"></h3><button class="close-btn">&times;</button></div>
      <div class="modal-body" id="modalBody"></div>
      <div class="modal-footer"><button class="btn close-btn">Fechar</button></div>
    </div>
  </div>

  <script type="module">
    // Importações do Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

    // Sua configuração do Firebase que você forneceu
    const firebaseConfig = {
      apiKey: "AIzaSyANadM-WbuGFKp5dz_09rjtsLUX-DTu908",
      authDomain: "etiquetas-falhas.firebaseapp.com",
      projectId: "etiquetas-falhas",
      storageBucket: "etiquetas-falhas.appspot.com",
      messagingSenderId: "895360142111",
      appId: "1:895360142111:web:864dc9b0d4c62016dc3e2a",
      measurementId: "G-31F5QV4YZ8"
    };

    // Inicializa o Firebase e o Firestore
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    document.addEventListener('DOMContentLoaded', () => {
      // --- CONSTANTES E VARIÁVEIS GLOBAIS ---
      const VISITOR_KEY = 'site_visitors_v11';
      const THEME_KEY = 'site_theme_v11';
      const unidades = ["ALTIPLANO", "BAIRRO DOS ESTADOS", "BANCARIOS", "BAYEUX", "BESSA", "BESSA II", "CABEDELO", "CRISTO REDENTOR", "CRUZ DAS ARMAS", "EPITÁCIO", "GEISEL", "GUARABIRA", "INTERMARES", "MAMANGUAPE", "MANAÍRA", "MANGABEIRA", "NOVA DIAGNÓSTICO", "PATOS", "SANTA RITA", "SAPÉ", "SAPÉ II", "TAMBÁU", "TORRE", "VALENTINA", "COLETA DOMICILIAR"];
      const TOTAL_UNIDADES = unidades.length;
      let chartInstances = {};
      let allFeedbacks = []; // Cache local dos dados para evitar múltiplas leituras

      // --- SELETORES DE DOM ---
      const dom = {
        mainPage: document.getElementById('main-page'),
        reportPage: document.getElementById('report-page'),
        aiReportBtn: document.getElementById('aiReportBtn'),
        backToMainBtn: document.getElementById('backToMainBtn'),
        form: document.getElementById('feedForm'),
        unidadeSelect: document.getElementById('unidade'),
        checklistContainer: document.getElementById('checklist-container'),
        mainModal: document.getElementById('mainModal'),
        modalTitle: document.getElementById('modalTitle'),
        modalBody: document.getElementById('modalBody'),
        themeToggleBtn: document.getElementById('themeToggleBtn'),
        infoBtn: document.getElementById('infoBtn'),
        viewRecordsBtn: document.getElementById('viewRecordsBtn'),
        generateAiTextBtn: document.getElementById('generateAiTextBtn'),
        aiReportOutput: document.getElementById('ai-report-output'),
        copyReportBtn: document.getElementById('copyReportBtn'),
        generatePdfBtn: document.getElementById('generatePdfBtn'),
        checklistCount: document.getElementById('checklist-count'),
        visitorCount: document.getElementById('visitor-count'),
        numericalSummary: document.getElementById('numerical-summary'),
        registerBtn: document.getElementById('registerBtn')
      };

      // --- LÓGICA DE DADOS OTIMIZADA COM FIREBASE ---
      const dataService = {
        listenForUpdates: (callback) => {
          const feedbacksCol = collection(db, 'falhas');
          onSnapshot(feedbacksCol, (snapshot) => {
            allFeedbacks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            callback(allFeedbacks);
          });
        },
        addFeedback: async (feedbackData) => {
          try {
            await addDoc(collection(db, 'falhas'), feedbackData);
          } catch (e) {
            console.error("Erro ao adicionar documento: ", e);
            uiService.showModal('Erro', 'Não foi possível registrar a falha. Verifique sua conexão e tente novamente.');
          }
        },
        processData: (feedbacks) => {
          const totalFalhas = feedbacks.reduce((sum, f) => sum + parseInt(f.quantidade || 0), 0);
          const falhasPorUnidade = feedbacks.reduce((acc, f) => {
            if (f.unidade) acc[f.unidade] = (acc[f.unidade] || 0) + parseInt(f.quantidade || 0);
            return acc;
          }, {});
          const unidadesComRegistro = new Set(feedbacks.map(f => f.unidade));
          return { totalFalhas, falhasPorUnidade, unidadesComRegistro };
        }
      };

      // --- LÓGICA DE UI ---
      const uiService = {
        showPage: (pageId) => {
          document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
          document.getElementById(pageId).classList.add('active');
        },
        showModal: (title, content) => {
          dom.modalTitle.innerHTML = title;
          dom.modalBody.innerHTML = content;
          dom.mainModal.style.display = 'flex';
        },
        applyTheme: (theme) => {
          document.documentElement.className = theme;
          dom.themeToggleBtn.innerHTML = theme === 'dark-mode' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
          localStorage.setItem(THEME_KEY, theme);
        },
        updateMainPage: (feedbacks) => {
          const { totalFalhas, falhasPorUnidade, unidadesComRegistro } = dataService.processData(feedbacks);
          
          dom.numericalSummary.innerHTML = `<div class="stat-card"><i class="fas fa-exclamation-triangle"></i><h4>Total de Falhas</h4><p>${totalFalhas}</p></div><div class="stat-card"><i class="fas fa-sitemap"></i><h4>Unidades com Registro</h4><p>${unidadesComRegistro.size}</p></div><div class="stat-card"><h4>Detalhamento</h4><ul id="unit-breakdown-list">${Object.keys(falhasPorUnidade).length > 0 ? Object.entries(falhasPorUnidade).map(([unit, count]) => `<li><strong>${unit}:</strong> ${count}</li>`).join('') : '<li>Nenhum registro.</li>'}</ul></div>`;

          dom.checklistCount.textContent = `Unidades com registro: ${unidadesComRegistro.size} / ${TOTAL_UNIDADES}`;
          document.querySelectorAll('#checklist-container input').forEach(cb => {
            cb.checked = unidadesComRegistro.has(cb.dataset.unit);
          });
        },
        drawReportCharts: () => {
          Object.values(chartInstances).forEach(chart => chart.destroy());
          const { falhasPorUnidade, unidadesComRegistro } = dataService.processData(allFeedbacks);
          const top5Unidades = Object.entries(falhasPorUnidade).sort((a, b) => b[1] - a[1]).slice(0, 5);
          const chartColors = ['#3498db', '#e74c3c', '#9b59b6', '#f1c40f', '#2ecc71', '#1abc9c', '#34495e', '#e67e22'];
          
          // CORREÇÃO: Opções comuns para os gráficos
          const commonChartOptions = { 
            responsive: true, 
            maintainAspectRatio: false, // <-- CORREÇÃO: Essencial para respeitar a altura do container
            animation: { duration: 1000 } 
          };

          chartInstances.failuresByUnit = new Chart(document.getElementById('failuresByUnitChart'), { type: 'pie', data: { labels: Object.keys(falhasPorUnidade), datasets: [{ data: Object.values(falhasPorUnidade), backgroundColor: chartColors }] }, options: { ...commonChartOptions, plugins: { legend: { position: 'top' } } } });
          chartInstances.reportingUnits = new Chart(document.getElementById('reportingUnitsChart'), { type: 'pie', data: { labels: ['Com Registro', 'Sem Registro'], datasets: [{ data: [unidadesComRegistro.size, TOTAL_UNIDADES - unidadesComRegistro.size], backgroundColor: ['#2ecc71', '#bdc3c7'] }] }, options: { ...commonChartOptions, plugins: { legend: { position: 'top' } } } });
          chartInstances.topUnits = new Chart(document.getElementById('topUnitsChart'), { type: 'bar', data: { labels: top5Unidades.map(item => item[0]), datasets: [{ label: 'Nº de Falhas', data: top5Unidades.map(item => item[1]), backgroundColor: '#3498db' }] }, options: { ...commonChartOptions, indexAxis: 'y', plugins: { legend: { display: false } } } });
        }
      };

      // --- LÓGICA DA APLICAÇÃO ---
      const app = {
        init: () => {
          app.bindEventListeners();
          uiService.applyTheme(localStorage.getItem(THEME_KEY) || 'light-mode');
          
          unidades.sort().forEach(unit => {
            dom.unidadeSelect.add(new Option(unit, unit));
            dom.checklistContainer.insertAdjacentHTML('beforeend', `<label><input type="checkbox" data-unit="${unit}"> ${unit}</label>`);
          });
          
          let visitorCount = parseInt(localStorage.getItem(VISITOR_KEY) || '0');
          if (!sessionStorage.getItem('visited')) {
            visitorCount++;
            localStorage.setItem(VISITOR_KEY, visitorCount);
            sessionStorage.setItem('visited', 'true');
          }
          dom.visitorCount.textContent = `Total de Visitas: ${visitorCount}`;
          
          dataService.listenForUpdates(uiService.updateMainPage);
        },
        bindEventListeners: () => {
          dom.aiReportBtn.addEventListener('click', () => {
            uiService.showPage('report-page');
            uiService.drawReportCharts();
          });
          dom.backToMainBtn.addEventListener('click', () => {
            uiService.showPage('main-page');
            Object.values(chartInstances).forEach(chart => chart.destroy());
          });
          dom.form.addEventListener('submit', app.handleFormSubmit);
          dom.themeToggleBtn.addEventListener('click', () => uiService.applyTheme(document.documentElement.classList.contains('dark-mode') ? 'light-mode' : 'dark-mode'));
          dom.infoBtn.addEventListener('click', () => uiService.showModal('<i class="fas fa-info-circle"></i> Sobre', `<p>Ferramenta para registrar e visualizar falhas em etiquetas.</p><ul><li>Preencha o <strong>formulário</strong> para registrar uma ocorrência.</li><li>O <strong>resumo geral</strong> é atualizado automaticamente.</li><li>Clique em <i class="fas fa-robot"></i> para gerar um <strong>relatório com IA</strong>.</li></ul>`));
          dom.viewRecordsBtn.addEventListener('click', app.handleViewRecords);
          dom.generateAiTextBtn.addEventListener('click', app.handleGenerateAiReport);
          dom.copyReportBtn.addEventListener('click', () => navigator.clipboard.writeText(dom.aiReportOutput.textContent).then(() => uiService.showModal('Copiado!', '<p>Relatório copiado para a área de transferência.</p>')));
          dom.generatePdfBtn.addEventListener('click', app.handleGeneratePdf);

          dom.mainModal.querySelectorAll('.close-btn').forEach(btn => btn.onclick = () => dom.mainModal.style.display = 'none');
          dom.mainModal.onclick = (event) => { if (event.target === dom.mainModal) dom.mainModal.style.display = 'none'; };
        },
        handleFormSubmit: async (event) => {
          event.preventDefault();
          let isValid = true;
          dom.form.querySelectorAll('[required]').forEach(input => {
            if (!input.value.trim()) { isValid = false; input.style.borderColor = 'var(--danger-color)'; } 
            else { input.style.borderColor = 'var(--border-color)'; }
          });
          if (!isValid) { uiService.showModal('Atenção!', '<p>Por favor, preencha todos os campos obrigatórios.</p>'); return; }

          dom.registerBtn.disabled = true; dom.registerBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Registrando...';
          
          const data = Object.fromEntries(new FormData(dom.form).entries());
          data.timestamp = new Date().toLocaleString('pt-BR');
          
          await dataService.addFeedback(data);
          
          setTimeout(() => { 
            uiService.showModal('<i class="fas fa-check-circle"></i> Sucesso!', '<p>Registro de falha enviado com sucesso.</p>'); 
            dom.form.reset(); 
            dom.registerBtn.disabled = false; dom.registerBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Registrar Falha'; 
          }, 500);
        },
        handleViewRecords: () => {
          let tableHtml = '<p>Nenhum registro encontrado.</p>';
          if (allFeedbacks.length > 0) {
            tableHtml = `<div style="max-height: 400px; overflow-y: auto;"><table id="recordsTable"><thead><tr><th>Data</th><th>Unidade</th><th>Qtde</th><th>Responsável</th><th>Comentário</th><th>Registro</th></tr></thead><tbody>${allFeedbacks.map(r => `<tr><td>${r.data||''}</td><td>${r.unidade||''}</td><td>${r.quantidade||''}</td><td>${r.responsavel||''}</td><td>${r.comentario||''}</td><td>${r.timestamp||''}</td></tr>`).join('')}</tbody></table></div>`;
          }
          uiService.showModal('<i class="fas fa-list-alt"></i> Registros Salvos', tableHtml);
        },
        handleGenerateAiReport: async () => {
          dom.generateAiTextBtn.disabled = true;
          dom.generateAiTextBtn.innerHTML = '<div class="loader"></div> Gerando...';
          dom.aiReportOutput.textContent = "Analisando dados e compilando o relatório...";
          
          if (allFeedbacks.length === 0) {
            dom.aiReportOutput.textContent = "Não há dados para gerar um relatório.";
            dom.generateAiTextBtn.disabled = false; dom.generateAiTextBtn.innerHTML = '<i class="fas fa-cogs"></i> Gerar Análise';
            return;
          }
          const dataSummary = allFeedbacks.map(f => `Unidade: ${f.unidade}, Qtde: ${f.quantidade}, Desc: ${f.comentario}`).join('; ');
          const prompt = `Aja como um analista de qualidade. Baseado nos dados de falhas de etiquetas a seguir, escreva um relatório formal e conciso para o fornecedor. O relatório deve: 1. Começar com uma saudação formal. 2. Apresentar um resumo do problema, incluindo total de falhas e de unidades afetadas. 3. Listar as unidades mais críticas. 4. Mencionar os tipos de problemas comuns. 5. Concluir solicitando uma análise e plano de ação. Assine como "Equipe de Suprimentos". Dados: ${dataSummary}`;
          
          try {
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
            const apiKey = ""; // Provided by environment
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error(`Erro na API: ${response.status}`);
            const result = await response.json();
            const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!text) throw new Error("Resposta da IA em formato inesperado.");

            dom.aiReportOutput.textContent = text;
            dom.copyReportBtn.disabled = false;
            dom.generatePdfBtn.disabled = false;
          } catch (error) {
            dom.aiReportOutput.textContent = `Ocorreu um erro ao gerar o relatório. Tente novamente.\nDetalhe: ${error.message}`;
          } finally {
            dom.generateAiTextBtn.disabled = false; dom.generateAiTextBtn.innerHTML = '<i class="fas fa-cogs"></i> Gerar Novamente';
          }
        },
        handleGeneratePdf: async () => {
          const btn = dom.generatePdfBtn;
          btn.disabled = true; btn.innerHTML = '<div class="loader"></div> Gerando...';

          const element = document.getElementById('report-content-to-print');
          const opt = {
            margin: 0.5, filename: 'relatorio_falhas_etiquetas.pdf', image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2, useCORS: true, logging: false },
            jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
          };
          
          Chart.defaults.animation.duration = 0;
          uiService.drawReportCharts();

          setTimeout(() => {
            html2pdf().from(element).set(opt).save().then(() => {
              btn.disabled = false; btn.innerHTML = '<i class="fas fa-file-pdf"></i> Gerar PDF';
              Chart.defaults.animation.duration = 1000;
              uiService.drawReportCharts();
            });
          }, 500);
        }
      };

      // --- INICIALIZAÇÃO DA APLICAÇÃO ---
      app.init();
    });
  </script>
</body>
</html>
